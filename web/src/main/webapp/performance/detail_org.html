<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>공연정보</title>

<link rel='stylesheet' href='../../node_modules/bootstrap/dist/css/bootstrap.min.css'>
<link rel='stylesheet' href='../../css/style1.css'>

<!-- 댓글 관련 -->
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


<style> 
    span{margin: 20px;}
    .w3-third{width:500px;}
    .w3-twothird{margin-left:50px;width:500px;}
    #detail-td1{width:500px;} 
    #detail-td2{width:900px;}
    html,body,h1,h2,h3,h4,h5 {font-family: "Raleway", sans-serif}
    
</style>
</head>
<body>
<div class='container'>
<header></header>

<h1></h1>







<div id='general-view'>

<form id='formList'>
   <div class="w3-panel">
    <div class="w3-row-padding" style="margin:0 -16px">
      <div class="w3-third">
        <h5>관련 영상</h5>
            <div class="col-sm-100 embed-responsive embed-responsive-16by9">
                <iframe class="embed-responsive-item" id="video" src="https://www.youtube.com/embed/zpOULjyy-n8?rel=0" allowfullscreen></iframe>
            </div>
      </div>
      <div class="w3-twothird">
        <h5>상세 정보</h5>
        <table id="detail-table" class="w3-table w3-striped w3-white"></table>
      </div>
    </div>
  </div>
  <hr>
</form>


<div class='form-group row'>
<div class='col-sm-10'>
<!-- <button id="addBtn" type="button" class='btn btn-primary btn-sm my-new'>공연 추가</button> -->
<button id="updateBtn" type="button" class='btn btn-primary btn-sm my-view'>공연 수정</button>
<button id="deleteBtn" type="button" class='btn btn-primary btn-sm my-view'>공연 삭제</button>
</div>
</div>

<form id="formjjim">

<div class='form-group row my-jjim jjim'>
<label class='col-sm-2 col-form-label'></label>
<div class='col-sm-10'>
    <button id='jjim' type="button" class='btn btn-primary btn-sm jjim'>찜하기</button>
    <span></span>
    
    <button id='share' type="button" class='btn btn-primary btn-sm jjim'>공유하기</button>
    <span></span>
    
    <label for='rating' class='col-sm-2 col-form-label rating'></label>
    <input class='col-sm-2 rating' type='number' min="-10" max="100" id='rating' name='rating' value=''>
    <button id="ratingBtn"type="button" class='btn btn-primary btn-sm rating'>점수주기</button>
    
</div>
</div>


<!-- <div id="rating" class="form-row">
    <div class="col">
    <input class='"form-control mb-2 mr-sm-2 rating' id='rating' type='number' min="-10" max="100" name='rating' value=''>
    </div>
    <div class="col">
    <button id="ratingBtn"type="button" class='btn btn-primary btn-sm rating'>점수주기</button>
    </div>
</div> -->

<!-- <div class='form-group row ripple'>
<label for='ripple' class='col-sm-2 col-form-label'>댓글</label>
<div class='col-sm-10'>
<textarea class='form-control' id='ripple' name='ripple' value=''></textarea>
<button id="rippleBtn"type="button" class='btn btn-primary btn-sm'>등록</button>
</div>
</div> -->

</form>



<div id="comment" data-role="collapsible">
    <h3>댓글</h3>

    <form id="comment_new_form" method="post" action="https://opentutorials.org/comment/add_ajax" data-ajax="true">
        <!-- <div class="profile_image">
            <img src="/download/1518169411347_0.jpg"  height="50" alt="">
        </div> -->

        <div class="form_wrapper">
            <dl class="comment_form_content">
                <!-- <dt>댓글 본문</dt> -->
                <dd>
                    <!-- <div id="reply_indicator">
                        <a>리체님의 댓글에 대한 답글입니다.</a>
                        <input type="hidden" name="parent" value="">
                        <a class="btn btn_unchain" href="#">삭제</a>
                    </div> -->
                    <!-- <textarea name="cmt_content"></textarea> -->
                    <textarea class='form-control' id='ripple' name='ripple' rows='5' value=''></textarea>
                </dd>
            </dl>
            <!-- <dl class="comment_form_writer">
                <dt>작성자</dt>
                <dd><input type="text" name="username" placeholder="이름"></dd>
            </dl>
            <dl class="comment_form_password">
                <dt>비밀번호</dt>
                <dd><input type="password" name="password" placeholder="비밀번호"></dd>
            </dl> -->
            <div class="buttons">
                <!-- <input type="hidden" name="course_id" value="0">
                <input type="hidden" name="module_id" value="1976">
                <input type="hidden" name="topic_id" value="0"> -->

                <button id="rippleBtn"type="button" class='btn btn-primary btn-sm' style="float:right">댓글달기</button>
            </div>
        </div>
    </form>
    <br><br>
    <ol id="comment_list"></ol>

    <!-- <div id="cmt_more" class="hidden">
        <a href="#"><span>더 보기</span></a>
    </div> -->
</div>  
    


<table id="ripplelist" class='table table-hover'>
<thead>
<tr>
<!-- <th></th><th></th> -->
</tr>
</thead>
<tbody></tbody>
</table>


</div>  <!-- general view -->


<div id='artist-view'>




<!-- 
<form id='formData' enctype="multipart/form-data">
<div class='form-group row'>
<label for='no' class='col-sm-2 col-form-label'>공연번호</label>
<div class='col-sm-10'>
<input class='form-control' readonly id='no' type='number' name='no' value='0'>
</div>
</div>

<div class='form-group row'>
<label class='col-sm-2 col-form-label'>공연사진/영상</label>
<div class='col-sm-10' id='medias' value=''>
</div>
</div>

<div class='form-group row'>
<label for='name' class='col-sm-2 col-form-label'>공연명</label>
<div class='col-sm-10'>
<input class='form-control' id='name' type='text' name='name' value=''>
</div>
</div>

<div class='form-group row'>
<label for='genre' class='col-sm-2 col-form-label'>공연장르</label>
<div class='col-sm-10'>

<select class="custom-select" id="genre" name="genre" value=''>
  <option selected></option>
  <option value='솔로'>솔로</option>
  <option value='그룹'>그룹</option>
  <option value='발라드'>발라드</option>
  <option value='R & B'>R & B</option>
  <option value='락'>락</option>
  <option value='랩'>랩</option>
  <option value='개그'>개그</option>
  <option value='마술'>마술</option>
</select>
</div>
</div>

<div class='form-group row'>
<label for='joinDate' class='col-sm-2 col-form-label'>공연날짜</label>
<div class='col-sm-10'>
<input class='form-control' id='entryDate' type='datetime' name='entryDate'  value=''>
</div>
</div>

<div class='form-group row'>
<label for='location' class='col-sm-2 col-form-label'>공연장소</label>
<div class='col-sm-10'>
<input class='form-control' id='location' type='text' name='location' value=''>
</div>
</div>

<div class='form-group row'>
<label for='detailDesc' class='col-sm-2 col-form-label'>공연내용</label>
<div class='col-sm-10'>
<textarea class='form-control' id='detailDesc' name='detailDesc' rows='5' value=''></textarea>
</div>
</div>

<div class='form-group row'>
<label for='specialDesc' class='col-sm-2 col-form-label'>특이사항</label>
<div class='col-sm-10'>
<input class='form-control' id='specialDesc' type='text' name='specialDesc' value=''>
</div>
</div>

<div class='form-group row'>
<label for='file1' class='col-sm-2 col-form-label'>파일1</label>
<div class='col-sm-10'>
<input type="file" class="form-control-file" id="file1" name="files" value=''>
</div>
</div>

<div class='form-group row'>
<label for='file2' class='col-sm-2 col-form-label'>파일2</label>
<div class='col-sm-10'>
<input type="file" class="form-control-file" id="file2" name="files" value=''>
</div>
</div>

<div class='form-group row'>
<label for='file3' class='col-sm-2 col-form-label'>파일3</label>
<div class='col-sm-10'>
<input type="file" class="form-control-file" id="file3" name="files" value=''>
</div>
</div>

</form>  
#form -->


 


</div>  <!-- artist view -->

<footer></footer>
</div>


<script src='../node_modules/jquery/dist/jquery.min.js'></script>
<script src='../node_modules/popper.js/dist/umd/popper.min.js'></script>
<script src='../node_modules/bootstrap/dist/js/bootstrap.min.js'></script>



<script type="text/javascript">


var performInfo = {},
     pagearr,
    addBtn = $('#addBtn'),
    updateBtn = $('#updateBtn'),
    deleteBtn = $('#deleteBtn'),
    rippleBtn = $('#rippleBtn'),
    ratingBtn = $('#ratingBtn'),
    noItem = $('#no'),
    //memberNoItem = $('#memberNo'),
    nameItem = $('#name'),
    genreItem = $('#genre'),
    entryDateItem = $('#entryDate'),
    locationItem = $('#location'),
    detailDescItem = $('#detailDesc'),
    specialDescItem = $('#specialDesc'),
    mediasItem = $('#medias'),
    file1Item = $('#file1'),
    jjimItem = $('#jjim'),
    ratingItem = $('#rating'),
    rippleItem = $('#ripple'),
    infolist = $('#infolist > tbody'),
    ripplelist = $('#ripplelist > tbody'),
    detailtable = $('#detail-table');

$(document.body).on('login', (event, obj) => {
    console.log('로그인 정보 가져오기:', loginUser.type);
    load();
});

$('header').load('../header.html');

//$('footer').load('../footer.html');


var index = location.href.indexOf('?');

//$(document.body).on('login', (event, obj) => {

function load() {
    if (index != -1) { // 기존 데이터를 조회할 경우,
        var qs = location.href.substr(index + 1);
        pagearr = qs.split('=');
        $('h1').html("공연 정보");
        $('.my-new').css('display', 'none');
        $(() => {
            
            // 공연정보
            $.ajax('../json/performance/' + pagearr[1], {
                dataType: 'json',
                async : false,
                success: (result) => {
                    
                    // 다른 함수에서 사용
                    performInfo = result.data;
                    
                    //for (var i = 0; i < result.data.medias.length; i++) {
                    for (var data of performInfo.medias) {
                        if (data.filename != null) {
                            mediasItem.append("<img src='../download/" + data.filename + "' height=100>");
                            //mediasItem.append("<a href='/download/" + data.filename + "'>" + data.filename + "</a><br>");
                        }
                    };
                    
                    // formData
                    /* noItem.val(performInfo.no);
                    nameItem.val(performInfo.name);
                    genreItem.append('<option selected>' + performInfo.genre + '</option>')
                    entryDateItem.val(formatDate(performInfo.entryDate));
                    locationItem.val(performInfo.location);
                    detailDescItem.val(performInfo.detailDesc);
                    specialDescItem.val(performInfo.specialDesc); 
                    # form */
                    
                    
                    //detailtable
                    detailtable.html("");
                    $('<tr>').html(
                            "<td id='detail-td1'>" + "공연명" + "</td>" +
                            "<td id='detail-td2'>" + performInfo.name + "</td>"
                    ).appendTo(detailtable);
                    
                    $('<tr>').html(
                            "<td id='detail-td1'>" + "공연 장르" + "</td>" +
                            "<td id='detail-td2'>" + performInfo.genre + "</td>"
                    ).appendTo(detailtable);
                    
                    $('<tr>').html(
                            "<td id='detail-td1'>" + "공연 날짜" + "</td>" +
                            "<td id='detail-td2'>" + formatDate(performInfo.entryDate) + "</td>"
                    ).appendTo(detailtable);
                    
                    $('<tr>').html(
                            "<td id='detail-td1'>" + "공연 장소" + "</td>" +
                            "<td id='detail-td2'>" + performInfo.location + "</td>"
                    ).appendTo(detailtable);
                    
                    $('<tr>').html(
                            "<td id='detail-td1'>" + "공연 내용" + "</td>" +
                            "<td id='detail-td2'>" + performInfo.detailDesc + "</td>"
                    ).appendTo(detailtable);
                    
                    
                    if (loginUser.no != result.data.writer.no ) {
                        $('.my-view').css('display', 'none');
                    }
                    $('#formData').css('display', 'none');
                },
                error: () => {
                    window.alert('view 서버 실행 오류!');
                }
            });
            
            // 찜 정보
            if (loginUser.no == performInfo.writer.no) {
                $('.jjim').css('display', 'none');
            } else {
	            $.ajax('../json/performance/viewjjim', {
	                data: {
	                    //performanceNo: noItem.val()
	                    performanceNo: pagearr[1]
	                },
	                dataType: 'json',
	                method: 'POST',
	                success: (result) => {
	                    console.log(result.jjim);
	                    if (result.jjim == 1) {
	                        jjimItem.prop("checked", true);
	                    } else {
	                        jjimItem.prop("checked", false);
	                    }
	                },
	                error: () => {
	                    window.alert('viewjjim 서버 실행 오류!');
	                }
	            });
            }
            
            // 평점
            if (loginUser.no == performInfo.writer.no) {
                $('.rating').css('display', 'none');
            } else {
                $.ajax('../json/performance/checkrating', {
                    data: {
                        //performanceNo: noItem.val()
                        performanceNo: pagearr[1]
                    },
                    dataType: 'json',
                    method: 'POST',
                    success: (result) => {
                        if (result.rating == 1) {
                            $('.rating').css('display', 'none');
                        }
                    },
                    error: () => {
                        window.alert('checkrating 서버 실행 오류!');
                    }
                });
            }
            
            // 리플
            $.ajax('../json/performance/viewripple', {
                data: {
                    //performanceNo: noItem.val(),performInfo.no
                    performanceNo: pagearr[1]
                },
                dataType: 'json',
                method: 'POST',
                success: (result) => {
                    
                    ripplelist.html("");
                    console.log("ripple");
                    
                    for (var data of result.list) {
                        
                        $('<tr>').
                            html(
                                "<td>" + 
                                    "<img src='../download/" + data.writer.photo + "' height=50>" + "</td>" +
                                "<td>"  + data.writer.nickName + "<span>"+ formatDateTime(data.regDate) + "</spna>" +
                                    "<div>" + data.ripple +
                                "</td>"
                            ).appendTo(ripplelist);
                        
                        /* $('<tr>').html("<hr>").appendTo(ripplelist);
                        $('<p>').html("</p>").appendTo(ripplelist);
                        $('<tr>').html(data.writer.nickName + "</tr>").appendTo(ripplelist);
                        $('<tr>').html(data.ripple + "</tr>").appendTo(ripplelist);
                        $('<tr>').html(formatDateTime(data.regDate) + "</tr>").appendTo(ripplelist); */
                    }
                },
                error: () => {
                    window.alert('viewripple 서버 실행 오류!');
                }
            });
        });
        
    } /* else { // 신규 데이터 입력일 경우,
        $('h1').html("공연 등록");
        $('#general-view').css('display', 'none');
        $('.my-view').css('display', 'none');
        $('.my-view').css('display', 'none');
        $('.jjim').css('display', 'none');
        $('.ripple').css('display', 'none');
        $('.ripple').css('display', 'none');
    } 
    # form */
}



/* 
addBtn.click(() => {

    var formData = new FormData($("#formData")[0]);
    
    // 공연정보 전송
    $.ajax({
        url: '../json/performance/add',
        data: formData,
        dataType: 'json',
        processData: false,
        contentType: false,
        //cache: false,
        method: 'POST',
        success: function(result) {
            location.href = "list.html";
        },
        error: () => {
            window.alert('서버 실행 오류!');
        }
    });
});
# form */


updateBtn.click(() => {
    if (loginUser.type == '아티스트') {
        location.href = "form.html?no="+ performInfo.no;
    } else {
        alert("아티스트가 아닙니다.");
        return
    }
    
    /* if (updateBtn.text() == "공연 수정") {

        $('h1').html("공연 수정");
        //$('#artist-view').css('display', '');
        $('#general-view').css('display', 'none');
        $('#formData').css('display', 'inline');
        //$('#formList').css('display', 'none');
        //$('#formjjim').css('display', 'none');
        //$('#comment').css('display', 'none');
        //$('#ripplelist').css('display', 'none');
        //$('#deleteBtn').css('display', 'none');
        updateBtn.text("수정 저장"); 
        deleteBtn.text("수정 취소"); 
    } else {
        var formData = new FormData($("#formData")[0]);
    
        $.ajax({
           url: '../json/performance/update',
           data: formData,
           dataType: 'json',
           processData: false,
           contentType: false,
           //cache: false,
           method: 'POST',
           success: function(result) {
               location.href = "list.html";
           },
           error: () => {
               window.alert('서버 실행 오류!');
           }
        });
    
    } */
});

deleteBtn.click(() => {
    
    if (deleteBtn.text() == "수정 취소") {

        $('h1').html("공연 정보");
        
        $('#formData').css('display', 'none');
        $('#formList').css('display', '');
        //$('#deleteBtn').css('display', 'none');
        $('#formjjim').css('display', '');
        $('#comment').css('display', '');
        $('#ripplelist').css('display', '');
        updateBtn.text("공연 수정"); 
        deleteBtn.text("공연 삭제");
        
        
        $(() => {
            
            // 공연정보
            $.ajax('../json/performance/' + pagearr[1], {
                dataType: 'json',
                async : false,
                success: (result) => {
                    
                    // 다른 함수에서 사용
                    performInfo = result.data;
                    
                    //for (var i = 0; i < result.data.medias.length; i++) {
                    for (var data of performInfo.medias) {
                        if (data.filename != null) {
                            mediasItem.append("<img src='../download/" + data.filename + "' height=100>");
                            //mediasItem.append("<a href='/download/" + data.filename + "'>" + data.filename + "</a><br>");
                        }
                    };
                    
                    // formData
                    noItem.val(performInfo.no);
                    nameItem.val(performInfo.name);
                    genreItem.append('<option selected>' + performInfo.genre + '</option>')
                    entryDateItem.val(formatDate(performInfo.entryDate));
                    locationItem.val(performInfo.location);
                    detailDescItem.val(performInfo.detailDesc);
                    specialDescItem.val(performInfo.specialDesc);
                },
                error: () => {
                    window.alert('view 서버 실행 오류!');
                }
            });
        });
        
    } else {
        $.ajax('../json/performance/delete', {
            data: {
                no: noItem.val()
            },
            dataType: 'json',
            success: (result) => {
                location.href = "list.html";
            },
            error: () => {
                window.alert('서버 실행 오류!');
            }
        });
    }
});



$('#jjim').click(function() {
    var flag;
    
    if($(this).is(':checked')) {
        flag = '1';
    } else {
        flag = '0';
    }
    
    $.ajax('../json/performance/jjim', {
        data: {
            performanceNo: noItem.val(),
            //memberNo: memberNoItem.val(),
            jjimFlag: flag,
        },
        dataType: 'json',
        success: (result) => {
            //location.href = "list.html";
        },
        error: () => {
            window.alert('서버 실행 오류!');
        }
    });
});

ratingBtn.click(() => {
    $.ajax('../json/performance/addrating', {
        data: {
            performanceNo: noItem.val(),
            //memberNo: memberNoItem.val(),
            score: ratingItem.val()
        },
        dataType: 'json',
        method: 'POST',
        success: (result) => {
            $('.rating').css('display', 'none');
        },
        error: () => {
            window.alert('서버 실행 오류!');
        }
    });
});

rippleBtn.click(() => {
    $.ajax('../json/performance/addripple', {
        data: {
            performanceNo: noItem.val(),
            //memberNo: memberNoItem.val(),
            ripple: rippleItem.val()
        },
        dataType: 'json',
        method: 'POST',
        success: (result) => {
            window.alert('서버 실행 성공!');
        },
        error: () => {
            window.alert('서버 실행 오류!');
        }
    });
    
    $.ajax('../json/performance/viewripple', {
        data: {
            performanceNo: noItem.val(),
            //memberNo: memberNoItem.val()
        },
        dataType: 'json',
        method: 'POST',
        success: (result) => {
            
            ripplelist.html("");
            console.log("리플");
            
            for (var data of result.list) {
                console.log(data.ripple);
                /* $('<tr>').html(data.memberNo + "</tr>" +
                               data.ripple + "</tr>" +
                               formatDate(data.regDate) + "</tr>").appendTo(ripplelist); */
                $('<tr>').html(data.memberNo + "</tr>").appendTo(ripplelist);
                $('<tr>').html(data.ripple + "</tr>").appendTo(ripplelist);
                $('<tr>').html(formatDateTime(data.regDate) + "</tr>").appendTo(ripplelist);
            }
        },
        error: () => {
            window.alert('viewripple 서버 실행 오류!');
        }
    });
});


function formatDate(jason) {
    var jasondate = new Date(jason);
            
    return jasondate.getFullYear() + '-' +
    pad((jasondate.getMonth() + 1), 2) + '-' +
    pad(jasondate.getDate(), 2);
}

function formatDateTime(jason) {
    var jasondate = new Date(jason);
            
    return jasondate.getFullYear() + '-' +
    pad((jasondate.getMonth() + 1), 2) + '-' +
    pad(jasondate.getDate(), 2) + ' ' +
    pad(jasondate.getHours(), 2) + ':' +
    pad(jasondate.getMinutes(), 2) + ':' +
    pad(jasondate.getSeconds(), 2);
}

function pad(n, width) {
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join('0') + n;
}

</script>


</body>
</html>
